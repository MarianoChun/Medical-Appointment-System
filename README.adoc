= Bases de Datos I: Trabajo Práctico
Agustín Lautaro Escobar <agustinesco@outlook.es>; Francisco Ruiz <franciscoruizlezcano@gmail.com>; Mariano Chun <marianochun01@gmail.com> v1, {docdate}. Docentes Daniel Bertaccini y Hernán Rondelli
:title-page:
:numbered:
:source-highlighter: coderay
:tabsize: 4

== Introducción
El objetivo del proyecto es desarrollar un sistema de administración de turnos médicos que permita asignar turnos correctamente, mantener la información de los pacientes, registrar las atenciones realizadas, administrar las liquidaciones mensuales de los médicos y enviar notificaciones por correo electrónico a los pacientes en diferentes situaciones (reserva de turno, cancelación, recordatorio, pérdida de turno). Además, se requiere la creación de la base de datos relacional con tablas específicas y la implementación de stored procedures y triggers para la lógica del sistema. También se solicita la comparación del modelo relacional con un modelo NoSQL, utilizando la base de datos BoltDB y almacenando los datos en formato JSON. El proyecto deberá poder ejecutarse desde una aplicación CLI escrita en Go.

== Descripción

=== Decisiones de diseño
Debido a que eramos varios personas desarrollando al mismo tiempo, decidimos utilizar una división de tareas y estructura de proyecto. Gracias a ello logramos una mejor organización y comunicación entre los miembros del equipo. Por otra parte, gracias a la lectura del contenido de archivos que nos provee el lenguaje, pudimos implementar toda la creación de bases de datos, datos, primary keys, foreign keys, stored procedures y triggers mediante archivos `.sql`. Esto nos permitió una mejor organización y mantenimiento de la base de datos.

=== Problemas encontrados
Durante el desarrollo del proyecto nos encontramos con varios problemas:

1. Para contextualizar mejor el dominio del problema que presenta el proyecto, realizamos un diagrama de Modelo Relacional, de tal forma de poder identificar correctamente las
relaciones entre las tablas y tener una idea de su cardinalidad.

2. Con el fin de popular las tablas de la base de datos, tuvimos que utlizar la herramienta https://www.mockaroo.com/[mockaroo] para generar datos aleatorios.

3. Encontramos un desafío al desarrollar los procedimientos almacenados para la generación de turnos disponibles y el envío de correos electrónicos. En una primera iteración, intentamos utilizar el método max(id) para obtener el valor máximo del identificador y luego sumarle 1. Sin embargo, decidimos cambiar nuestra aproximación y optamos por utilizar el tipo de datos serial para los identificadores de las tablas pertinentes.

4. Para inicializar la creación de la base de datos y su esquema pertinente, tuvimos que realizar dos conexiones a PostreSQL. La primera conexión se utilizó para crear la base de datos y la segunda para crear el esquema. Esto se debió a que en una misma conexión no encontramos la posibilidad de cambiar de esquema.

5. A la hora de leer los archivos `.sql`, tuvimos inconvenientes con la lectura de los caracteres especiales y comentarios. Para solucionar este problema, utilizamos las funciones utilitarias de `kit/queries.go` para sanitizar el contenido de los scripts.

== Implementación

=== Estructura del proyecto
La estructuración del proyecto la consideramos esencial para organizar, planificar y desarrollar eficientemente la aplicación. Nos proporciona claridad, mejora la colaboración y la comunicación entre los miembros del equipo.

A continuación se muestra la estructura del proyecto:
[source, bash]
----
.
├── cmd
│   └── cli
├── internal
│   ├── db
│   ├── fk
│   ├── pk
│   ├── fk
│   ├── sp
│   ├── trigger
│   ├── appointment.go
│   ├── consultingroom.go
│   ├── insurance.go
│   └── patient.go
├── kit
├── nosql
├── sql
│   ├── data
│   ├── fk
│   ├── pk
│   ├── sp
│   ├── triggers
│   ├── schema.sql
│   └── database.sql
├── go.mod
└── go.sum
----

===== `/cmd`
Contiene todos los puntos de entrada e interacciones con el usuario de nuestra aplicación.

===== `/internal`
Contiene todos los componentes que consideramos core de nuestra aplicación.

===== `/kit`:
Se encuentran funciones útiles que utilizamos en cualquier parte de la aplicación.

===== `/nosql`
Contiene los archivos necesarios para la gestión de la base de datos no relacional.

===== `/sql`
Contiene los archivos `.sql` necesarios para la creación de la base de datos, datos pre insertados, primary key, foreign key, stored procedures y triggers.

===== Comandos
Para ejecutar la aplicación CLI, se debe ejecutar el siguiente comando: `go run cmd/cli/main.go`

=== SQL
==== DDL
===== Creación de la BDD y esquema
* Script de creación de la BDD, ubicado en `sql/database.sql`

* Script de creación del esquema de la BDD, ubicado en `sql/schema.sql`

===== Primary Keys
* Script de creación de las PKs, ubicado en `sql/pk/create.sql`

* Script de eliminación de las PKs, ubicado en `sql/pk/remove.sql`

===== Foreign Keys
* Script de creación ubicado en `sql/fk/create.sql`

* Script de eliminación ubicado en `sql/fk/remove.sql`

==== DML
===== Inserción de datos
* Script de inserción de datos para las obras sociales ubicado en `sql/data/1-obra_social.sql`

* Script de inserción de datos para los mediques ubicado en `sql/data/2-medique.sql`

* Script de inserción de datos para las cobertura ubicado en `sql/data/3-cobertura.sql`

* Script de inserción de datos para los consultorios ubicado en `sql/data/4-consultorio.sql`

* Script de inserción de datos para las agendas ubicado en `sql/data/5-agendas.sql`

* Script de inserción de datos para los pacientes ubicado en `sql/data/6-paciente.sql`

* Script de inserción de datos para las solicitudes de reservas ubicado en `sql/data/6-solicitud_reservas.sql`

==== Diagrama del modelo relacional
.Diagrama del Modelo Relacional
image::docs/images/diagram.png[]

=== Transacciones
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

==== Stored Procedures
===== Atender turno
* *Ubicación*: `sql/sp/attend_appointment.sql`
* *Descripción del proceso*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.
* *Aclaraciones y funciones utilizadas*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

===== Cancelar turno
* *Ubicación*: `sql/sp/cancel_appointment.sql`
* *Descripción del proceso*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.
* *Aclaraciones y funciones utilizadas*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

===== Crear turnos a partir de un año y mes
* *Ubicación*: `sql/sp/generate_available_appointment.sql`
* *Descripción del proceso*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.
* *Aclaraciones y funciones utilizadas*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

===== Generar liquidaciones para las obras sociales
* *Ubicación*: `sql/sp/generate_insurance_settlements.sql`
* *Descripción del proceso*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.
* *Aclaraciones y funciones utilizadas*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

===== Reservar turno
* *Ubicación*: `sql/sp/reserve_appointment.sql`
* *Descripción del proceso*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.
* *Aclaraciones y funciones utilizadas*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

===== Enviar emails de turno olvidados
* *Ubicación*: `sql/sp/send_reminder_email.sql`
* *Descripción del proceso*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.
* *Aclaraciones y funciones utilizadas*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

===== Enviar emails de recordatorios de turnos
* *Ubicación*: `sql/sp/send_reminder_email.sql`
* *Descripción del proceso*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.
* *Aclaraciones y funciones utilizadas*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

==== Triggers
===== Enviar email de confirmación cuando el turno fue reservado
* *Ubicación*: `sql/triggers/send_confirmation_email_on_appointment_reserved.sql`
* *Descripción del proceso*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.
* *Aclaraciones y funciones utilizadas*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

===== Enviar email cuando el turno fue cancelado
* *Ubicación*: `sql/triggers/send_email_on_appointment_canceled.sql`
* *Descripción del proceso*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.
* *Aclaraciones y funciones utilizadas*: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

=== NoSQL
==== Descripción
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

==== Sincronización de NoSQL con SQL
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

==== Visualización de los datos en la BDD NoSQL
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque tristique ornare euismod. Fusce placerat, enim eu placerat maximus, felis enim interdum nisl, a tempus felis sapien in nisi. In accumsan risus justo, sed egestas ligula hendrerit non. Aliquam ullamcorper iaculis feugiat.

== Conclusiones
El trabajo práctico logró desarrollar un sistema de administración de turnos médicos que cumple con los objetivos establecidos. Se superaron los desafíos encontrados durante el
proceso de desarrollo y se aplicaron soluciones efectivas. El trabajo en equipo y la utilización de herramientas adecuadas contribuyeron a la eficiencia y
calidad del resultado final. Además, el trabajo nos ayudó a comprender como podemos interactuar con la base de datos, no solo con las operaciones convencionales, sino
que tambien con otros elementos como stored procedures, triggers y transactions. Por otra parte, tambien contribuyó a nuestro aprendizaje trabajar tantos con bases
de datos sql y no sql, para tener una mayor noción de sus diferencias y la forma de trabajar cada una.